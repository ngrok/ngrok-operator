suite: test agent deployment
templates:
- agent/deployment.yaml
- agent/rbac.yaml
set:
  ingress:
    enabled: true
tests:
- it: Should match snapshot
  asserts:
  - matchSnapshot: {}
- it: Should set default agent.updateStrategy.type to RollingUpdate in values.yaml
  set:
    agent:
      updateStrategy:
        type: RollingUpdate
  template: agent/deployment.yaml
  asserts:
  - equal:
      path: spec.strategy.type
      value: RollingUpdate
- it: Adds .Values.podLabels to the controller deployment podspec
  set:
    podLabels:
      labelKey1: labelValue1
      labelKey2: labelValue2
  template: agent/deployment.yaml
  asserts:
  - isSubset:
      path: spec.template.metadata.labels
      content:
        labelKey1: labelValue1
        labelKey2: labelValue2
- it: Does not add .Values.podLabels to the controller deployment's selector
  set:
    podLabels:
      labelKey1: labelValue1
      labelKey2: labelValue2
  template: agent/deployment.yaml
  asserts:
  - isNotSubset:
      path: spec.selector.matchLabels
      content:
        labelKey1: labelValue1
        labelKey2: labelValue2
- it: Supports selecting which nodes the agent should run on with node selectors
  set:
    agent:
      nodeSelector: &nodeSelector
        disktype: ssd
  template: agent/deployment.yaml
  asserts:
  - equal:
      path: spec.template.spec.nodeSelector
      value: *nodeSelector
- it: Supports setting tolerations on the agent pods
  set:
    agent:
      tolerations:
      - &toleration
        key: "key1"
        operator: "Equal"
        value: "value1"
        effect: "NoSchedule"
  template: agent/deployment.yaml
  asserts:
  - contains:
      path: spec.template.spec.tolerations
      content: *toleration
- it: Supports setting topologySpreadConstraints on the agent pods
  set:
    agent:
      topologySpreadConstraints:
      - &tsc
        maxSkew: 1
        topologyKey: kubernetes.io/hostname
        whenUnsatisfiable: DoNotSchedule
        labelSelector:
          matchLabels:
            app: foo
        matchLabelKeys:
          - pod-template-hash
  template: agent/deployment.yaml
  asserts:
  - contains:
      path: spec.template.spec.topologySpreadConstraints
      content: *tsc
- it: Supports setting resources on the agent pods
  set:
    agent:
      resources: &resources
        requests:
          memory: "128Mi"
          cpu: "500m"
        limits:
          memory: "256Mi"
          cpu: "1000m"
  template: agent/deployment.yaml
  asserts:
  - equal:
      path: spec.template.spec.containers[0].resources
      value: *resources
- it: Sets terminationGracePeriodSeconds by default
  template: agent/deployment.yaml
  asserts:
  - equal:
      path: spec.template.spec.terminationGracePeriodSeconds
      value: 30
- it: Allows overriding terminationGracePeriodSeconds for the agent
  set:
    agent:
      terminationGracePeriodSeconds: 45
  template: agent/deployment.yaml
  asserts:
  - equal:
      path: spec.template.spec.terminationGracePeriodSeconds
      value: 45
- it: Should set the default domain reclaim policy arg
  set:
    defaultDomainReclaimPolicy: "Retain"
  template: agent/deployment.yaml
  asserts:
  - contains:
      path: spec.template.spec.containers[0].args
      content: --default-domain-reclaim-policy=Retain
- it: Falls back to global podAnnotations when agent.podAnnotations is not set
  set:
    podAnnotations:
      global-annotation: global-value
  template: agent/deployment.yaml
  asserts:
  - isSubset:
      path: spec.template.metadata.annotations
      content:
        global-annotation: global-value
- it: Uses agent.podAnnotations when set instead of global podAnnotations
  set:
    podAnnotations:
      global-annotation: global-value
    agent:
      podAnnotations:
        agent-annotation: agent-value
  template: agent/deployment.yaml
  asserts:
  - isSubset:
      path: spec.template.metadata.annotations
      content:
        agent-annotation: agent-value
  - isNotSubset:
      path: spec.template.metadata.annotations
      content:
        global-annotation: global-value
- it: Supports Datadog autodiscovery annotations on agent pods
  set:
    agent:
      podAnnotations:
        ad.datadoghq.com/agent.logs: '[{"service":"ngrok-agent","source":"ngrok-agent"}]'
  template: agent/deployment.yaml
  asserts:
  - isSubset:
      path: spec.template.metadata.annotations
      content:
        ad.datadoghq.com/agent.logs: '[{"service":"ngrok-agent","source":"ngrok-agent"}]'
- it: Should pass --watch-namespace flag when ingress.watchNamespace is set
  set:
    ingress:
      watchNamespace: my-namespace
  template: agent/deployment.yaml
  asserts:
  - contains:
      path: spec.template.spec.containers[0].args
      content: --watch-namespace=my-namespace
- it: Should pass --watch-namespace flag when watchNamespace is set
  set:
    watchNamespace: my-namespace
  template: agent/deployment.yaml
  asserts:
  - contains:
      path: spec.template.spec.containers[0].args
      content: --watch-namespace=my-namespace
- it: Should prefer watchNamespace over ingress.watchNamespace
  set:
    watchNamespace: preferred-namespace
    ingress:
      watchNamespace: fallback-namespace
  template: agent/deployment.yaml
  asserts:
  - contains:
      path: spec.template.spec.containers[0].args
      content: --watch-namespace=preferred-namespace
- it: Should not include --watch-namespace flag when not set
  set:
    ingress:
      watchNamespace: ""
  template: agent/deployment.yaml
  asserts:
  - notContains:
      path: spec.template.spec.containers[0].args
      content: --watch-namespace=
