suite: test agent-deployment
templates:
- agent/deployment.yaml
- agent/rbac.yaml
- credentials-secret.yaml
tests:
- it: Should have default rolling update strategy with maxSurge 0 and maxUnavailable 1
  set:
    ingress.enabled: true
    credentials.apiKey: test-api-key
    credentials.authtoken: test-authtoken
  template: agent/deployment.yaml
  documentIndex: 0
  asserts:
  - equal:
      path: spec.strategy.type
      value: RollingUpdate
  - equal:
      path: spec.strategy.rollingUpdate.maxSurge
      value: 0
  - equal:
      path: spec.strategy.rollingUpdate.maxUnavailable
      value: 1

- it: Should allow overriding strategy type to Recreate
  set:
    ingress.enabled: true
    credentials.apiKey: test-api-key
    credentials.authtoken: test-authtoken
    agent.strategy:
      type: Recreate
  template: agent/deployment.yaml
  documentIndex: 0
  asserts:
  - equal:
      path: spec.strategy.type
      value: Recreate

- it: Should allow custom rollingUpdate values
  set:
    ingress.enabled: true
    credentials.apiKey: test-api-key
    credentials.authtoken: test-authtoken
    agent.strategy.rollingUpdate.maxSurge: 1
    agent.strategy.rollingUpdate.maxUnavailable: 0
  template: agent/deployment.yaml
  documentIndex: 0
  asserts:
  - equal:
      path: spec.strategy.type
      value: RollingUpdate
  - equal:
      path: spec.strategy.rollingUpdate.maxSurge
      value: 1
  - equal:
      path: spec.strategy.rollingUpdate.maxUnavailable
      value: 0

- it: Should have default terminationGracePeriodSeconds of 30
  set:
    ingress.enabled: true
    credentials.apiKey: test-api-key
    credentials.authtoken: test-authtoken
  template: agent/deployment.yaml
  documentIndex: 0
  asserts:
  - equal:
      path: spec.template.spec.terminationGracePeriodSeconds
      value: 30

- it: Should allow custom terminationGracePeriodSeconds
  set:
    ingress.enabled: true
    credentials.apiKey: test-api-key
    credentials.authtoken: test-authtoken
    agent.terminationGracePeriodSeconds: 60
  template: agent/deployment.yaml
  documentIndex: 0
  asserts:
  - equal:
      path: spec.template.spec.terminationGracePeriodSeconds
      value: 60

- it: Should not be created when ingress.enabled is false
  set:
    ingress.enabled: false
    credentials.apiKey: test-api-key
    credentials.authtoken: test-authtoken
  template: agent/deployment.yaml
  asserts:
  - hasDocuments:
      count: 0
