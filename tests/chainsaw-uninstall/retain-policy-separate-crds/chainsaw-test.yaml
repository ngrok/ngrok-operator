# yaml-language-server: $schema=https://raw.githubusercontent.com/kyverno/chainsaw/main/.schemas/json/test-chainsaw-v1alpha1.json
apiVersion: chainsaw.kyverno.io/v1alpha1
kind: Test
metadata:
  name: retain-policy-separate-crds
spec:
  namespace: uninstall-test
  skipDelete: true
  timeouts:
    apply: 2m
    assert: 3m
    delete: 2m
    exec: 2m
  steps:
    # ============================================================
    # PHASE 1: Setup - Install CRDs separately, then operator
    # ============================================================
    - name: install Gateway API CRDs
      try:
        - script:
            timeout: 2m
            content: |
              # Install Gateway API CRDs (standard channel)
              kubectl apply -f https://github.com/kubernetes-sigs/gateway-api/releases/download/v1.0.0/standard-install.yaml
              
              # Wait for CRDs to be established before proceeding
              kubectl wait --for=condition=Established --timeout=60s crd/gatewayclasses.gateway.networking.k8s.io
              kubectl wait --for=condition=Established --timeout=60s crd/gateways.gateway.networking.k8s.io
              kubectl wait --for=condition=Established --timeout=60s crd/httproutes.gateway.networking.k8s.io
              echo "✓ Gateway API CRDs installed and ready"

    - name: install CRDs separately
      try:
        - script:
            timeout: 2m
            content: |
              helm upgrade ngrok-operator-crds ../../../helm/ngrok-crds --install \
                --namespace kube-system \
                --wait \
                --timeout 1m
              
              echo "CRDs installed separately"

    - name: deploy operator with drainPolicy Retain and installCRDs=false
      try:
        - script:
            timeout: 3m
            content: |
              make -C ../../../ docker-build kind-load-image

              # Install operator using base values + scenario-specific overrides
              helm upgrade ngrok-operator-uninstall-test ../../../helm/ngrok-operator --install \
                --namespace uninstall-test \
                --create-namespace \
                --values ../_fixtures/values-base.yaml \
                --values ./values.yaml \
                --set credentials.apiKey=${NGROK_API_KEY} \
                --set credentials.authtoken=${NGROK_AUTHTOKEN} \
                --wait \
                --timeout 2m

    - name: wait for KubernetesOperator to be registered
      try:
        - assert:
            timeout: 2m
            resource:
              apiVersion: ngrok.k8s.ngrok.com/v1alpha1
              kind: KubernetesOperator
              metadata:
                namespace: uninstall-test
              status:
                registrationStatus: registered
                (id != null): true

    - name: capture KubernetesOperator ID for later verification
      try:
        - script:
            timeout: 30s
            content: |
              KO_ID=$(kubectl get kubernetesoperator -n uninstall-test -o jsonpath='{.items[0].status.id}')
              echo "KubernetesOperator ID: $KO_ID"
              echo "$KO_ID" > /tmp/ko-id-retain-separate.txt

    # ============================================================
    # PHASE 2: Create resources that will be drained
    # ============================================================
    - name: create test resources
      try:
        - create:
            file: ../_fixtures/backend-service.yaml
        - create:
            file: ../_fixtures/cloudendpoint.yaml
        - create:
            file: ../_fixtures/agentendpoint.yaml
        - create:
            file: ../_fixtures/ingress.yaml
        # Gateway API resources
        - create:
            file: ../_fixtures/gateway-class.yaml
        - create:
            file: ../_fixtures/gateway.yaml
        - create:
            file: ../_fixtures/httproute.yaml

    - name: verify CloudEndpoint is ready
      try:
        - assert:
            timeout: 2m
            resource:
              apiVersion: ngrok.k8s.ngrok.com/v1alpha1
              kind: CloudEndpoint
              metadata:
                name: uninstall-test-cloud-ep
                namespace: uninstall-test
                finalizers:
                  - k8s.ngrok.com/finalizer
              status:
                (id != null): true

    - name: verify AgentEndpoint is ready
      try:
        - assert:
            timeout: 2m
            resource:
              apiVersion: ngrok.k8s.ngrok.com/v1alpha1
              kind: AgentEndpoint
              metadata:
                name: uninstall-test-agent-ep
                namespace: uninstall-test
                finalizers:
                  - k8s.ngrok.com/finalizer
              status:
                (conditions[?type == 'Ready'] | [0].status): "True"

    - name: verify Ingress has finalizer
      try:
        - assert:
            timeout: 2m
            resource:
              apiVersion: networking.k8s.io/v1
              kind: Ingress
              metadata:
                name: uninstall-test-ingress
                namespace: uninstall-test
                finalizers:
                  - k8s.ngrok.com/finalizer

    - name: verify HTTPRoute has finalizer
      try:
        - assert:
            timeout: 2m
            resource:
              apiVersion: gateway.networking.k8s.io/v1
              kind: HTTPRoute
              metadata:
                name: uninstall-test-httproute
                namespace: uninstall-test
                finalizers:
                  - k8s.ngrok.com/finalizer

    - name: verify Gateway has finalizer
      try:
        - assert:
            timeout: 2m
            resource:
              apiVersion: gateway.networking.k8s.io/v1
              kind: Gateway
              metadata:
                name: uninstall-test-gateway
                namespace: uninstall-test
                finalizers:
                  - k8s.ngrok.com/finalizer

    - name: verify endpoints exist in ngrok API
      try:
        - script:
            timeout: 60s
            content: |
              ../_fixtures/ngrok-api-helper.sh endpoint exists "uninstall-test-cloud-ep.internal"
              ../_fixtures/ngrok-api-helper.sh endpoint exists "uninstall-test-agent-ep.internal"
              ../_fixtures/ngrok-api-helper.sh endpoint exists "uninstall-test-ingress.internal"
              # Gateway API endpoint
              ../_fixtures/ngrok-api-helper.sh endpoint exists "uninstall-test-gateway.internal"

    # ============================================================
    # PHASE 3: Trigger drain via helm uninstall (operator only)
    # ============================================================
    - name: uninstall operator (triggers drain, CRDs remain)
      try:
        - script:
            timeout: 3m
            content: |
              echo "Starting helm uninstall - this triggers the drain process..."
              helm uninstall ngrok-operator-uninstall-test --namespace uninstall-test --wait --timeout 2m
              echo "Helm uninstall completed (operator only, CRDs still present)"

    # ============================================================
    # PHASE 4: Verify Retain policy preserved CloudEndpoint in ngrok API
    # ============================================================
    - name: verify CRDs still exist (installed separately)
      try:
        - script:
            timeout: 30s
            content: |
              # With separate CRDs, they should persist after operator uninstall
              if kubectl get crds 2>/dev/null | grep -q "ngrok"; then
                echo "✓ ngrok CRDs still exist (as expected with separate install)"
                kubectl get crds | grep ngrok
              else
                echo "✗ ngrok CRDs were removed unexpectedly"
                exit 1
              fi

    - name: verify CloudEndpoint CR exists but has NO finalizer
      try:
        - script:
            timeout: 30s
            content: |
              # CR should still exist (CRDs not deleted) but finalizer should be removed
              if ! kubectl get cloudendpoint uninstall-test-cloud-ep -n uninstall-test &>/dev/null; then
                echo "✗ CloudEndpoint CR was deleted unexpectedly"
                exit 1
              fi
              
              FINALIZERS=$(kubectl get cloudendpoint uninstall-test-cloud-ep -n uninstall-test -o jsonpath='{.metadata.finalizers}')
              if [ -z "$FINALIZERS" ] || [ "$FINALIZERS" = "[]" ] || [ "$FINALIZERS" = "null" ]; then
                echo "✓ CloudEndpoint exists without finalizer"
              else
                echo "✗ CloudEndpoint still has finalizers: $FINALIZERS"
                exit 1
              fi

    - name: verify AgentEndpoint CR exists but has NO finalizer
      try:
        - script:
            timeout: 30s
            content: |
              # CR should still exist but finalizer should be removed
              if ! kubectl get agentendpoint uninstall-test-agent-ep -n uninstall-test &>/dev/null; then
                echo "✗ AgentEndpoint CR was deleted unexpectedly"
                exit 1
              fi
              
              FINALIZERS=$(kubectl get agentendpoint uninstall-test-agent-ep -n uninstall-test -o jsonpath='{.metadata.finalizers}')
              if [ -z "$FINALIZERS" ] || [ "$FINALIZERS" = "[]" ] || [ "$FINALIZERS" = "null" ]; then
                echo "✓ AgentEndpoint exists without finalizer"
              else
                echo "✗ AgentEndpoint still has finalizers: $FINALIZERS"
                exit 1
              fi

    - name: verify Ingress finalizer was removed
      try:
        - script:
            timeout: 30s
            content: |
              # Ingress is a core K8s resource, should still exist but without finalizer
              if kubectl get ingress uninstall-test-ingress -n uninstall-test &>/dev/null; then
                FINALIZERS=$(kubectl get ingress uninstall-test-ingress -n uninstall-test -o jsonpath='{.metadata.finalizers}')
                if [ -z "$FINALIZERS" ] || [ "$FINALIZERS" = "[]" ] || [ "$FINALIZERS" = "null" ]; then
                  echo "✓ Ingress finalizer removed"
                else
                  echo "✗ Ingress still has finalizers: $FINALIZERS"
                  exit 1
                fi
              else
                echo "✗ Ingress was deleted unexpectedly"
                exit 1
              fi

    - name: verify Gateway API finalizers were removed
      try:
        - script:
            timeout: 30s
            content: |
              # Gateway and HTTPRoute are Gateway API resources (not ngrok CRDs), should still exist but without finalizers
              for RESOURCE in "gateway/uninstall-test-gateway" "httproute/uninstall-test-httproute"; do
                if kubectl get "$RESOURCE" -n uninstall-test &>/dev/null; then
                  FINALIZERS=$(kubectl get "$RESOURCE" -n uninstall-test -o jsonpath='{.metadata.finalizers}')
                  if [ -z "$FINALIZERS" ] || [ "$FINALIZERS" = "[]" ] || [ "$FINALIZERS" = "null" ]; then
                    echo "✓ $RESOURCE finalizer removed"
                  else
                    echo "✗ $RESOURCE still has finalizers: $FINALIZERS"
                    exit 1
                  fi
                else
                  echo "✗ $RESOURCE was deleted unexpectedly"
                  exit 1
                fi
              done

    - name: verify CloudEndpoint STILL EXISTS in ngrok API (Retain policy)
      try:
        - script:
            timeout: 60s
            content: |
              # With Retain policy, CloudEndpoints should be PRESERVED in ngrok API
              ../_fixtures/ngrok-api-helper.sh endpoint exists "uninstall-test-cloud-ep.internal"
              echo "✓ CloudEndpoint preserved as expected (Retain policy)"

    - name: verify ephemeral endpoints are gone
      try:
        - script:
            timeout: 60s
            content: |
              # AgentEndpoints are ephemeral - they go away when the agent pod stops
              # Ingress-generated endpoints and Gateway API endpoints are backed by CRDs that get deleted
              ../_fixtures/ngrok-api-helper.sh endpoint absent "uninstall-test-agent-ep.internal"
              ../_fixtures/ngrok-api-helper.sh endpoint absent "uninstall-test-ingress.internal"
              # Gateway API endpoint is also ephemeral
              ../_fixtures/ngrok-api-helper.sh endpoint absent "uninstall-test-gateway.internal"
              echo "✓ Ephemeral endpoints cleaned up as expected"

    - name: verify KubernetesOperator deregistered from ngrok API
      try:
        - script:
            timeout: 60s
            content: |
              KO_ID=$(cat /tmp/ko-id-retain-separate.txt)
              echo "Verifying KubernetesOperator $KO_ID is deregistered..."
              ../_fixtures/ngrok-api-helper.sh k8sop absent "$KO_ID"
              rm -f /tmp/ko-id-retain-separate.txt

    # ============================================================
    # PHASE 5: Cleanup retained CloudEndpoint from ngrok API
    # ============================================================
    - name: cleanup retained CloudEndpoint from ngrok API
      try:
        - script:
            timeout: 30s
            content: |
              echo "Cleaning up retained CloudEndpoint from ngrok API..."
              ../_fixtures/ngrok-api-helper.sh endpoint delete-matching "uninstall-test-cloud-ep"
              echo "✓ Retained CloudEndpoint cleaned up"

    - name: verify CloudEndpoint deleted after cleanup
      try:
        - script:
            timeout: 60s
            content: |
              ../_fixtures/ngrok-api-helper.sh endpoint absent "uninstall-test-cloud-ep.internal"
              echo "✓ CloudEndpoint cleaned up successfully"

    # ============================================================
    # PHASE 6: Uninstall CRD chart and verify cleanup
    # ============================================================
    - name: uninstall CRD chart
      try:
        - script:
            timeout: 2m
            content: |
              echo "Uninstalling CRD chart..."
              helm uninstall ngrok-operator-crds --namespace kube-system --wait --timeout 1m
              echo "CRD chart uninstalled"

    - name: verify CRDs and CRs are deleted
      try:
        - script:
            timeout: 30s
            content: |
              # CRDs should now be gone
              if kubectl get crds 2>/dev/null | grep -q "ngrok"; then
                echo "✗ ngrok CRDs still exist after CRD chart uninstall:"
                kubectl get crds | grep ngrok
                exit 1
              else
                echo "✓ All ngrok CRDs removed"
              fi
              
              # CRs should be gone with the CRDs (command should fail since CRD doesn't exist)
              if ! kubectl get cloudendpoint -n uninstall-test 2>&1 | grep -qE "(NotFound|doesn't have a resource type)"; then
                echo "✗ CloudEndpoint resources may still exist"
                kubectl get cloudendpoint -n uninstall-test 2>&1 || true
                exit 1
              fi
              echo "✓ CloudEndpoint CRD and CRs cleaned up"

    # ============================================================
    # PHASE 7: Cleanup
    # ============================================================
    - name: cleanup namespace
      try:
        - script:
            timeout: 30s
            content: |
              kubectl delete namespace uninstall-test --ignore-not-found --wait=false
              echo "Cleanup complete"
